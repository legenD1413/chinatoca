# 变更日志

## 2023-05-10：数据库诊断与修复工具增强

### 改进内容

1. **数据库诊断改进**
   - 增强了对BigInt值的JSON序列化处理
   - 改进了数据库连接错误的捕获和展示
   - 添加了更详细的日志记录，便于故障排除

2. **数据库修复工具增强**
   - 提供了多种表创建方式，包括：
     - 直接SQL创建
     - Prisma CLI命令创建
     - 手动SQLite命令创建
   - 增加了对常见错误的智能处理，如权限错误、数据库锁定等
   - 优化了错误反馈机制，提供更清晰的错误信息

3. **UI改进**
   - 添加了详细的手动修复指南
   - 改进了诊断结果的展示
   - 添加了查看/隐藏详细日志的功能

4. **文档更新**
   - 添加了故障排除指南
   - 记录了常见问题及解决方案
   - 补充了必要工具的安装说明

### 修复的问题

1. **PostmarkSetting表缺失问题**
   - 在首次初始化或迁移失败的情况下自动创建表
   - 提供多种备选创建方式，提高成功率

2. **错误处理优化**
   - 修复了空值检查问题，防止访问undefined属性导致的错误
   - 增强了BigInt序列化处理，避免JSON解析错误
   - 改进了权限错误和数据库锁定的处理

3. **异常情况处理**
   - 添加了对数据库锁定的检测和建议
   - 针对权限不足提供明确的提示和解决步骤
   - 对迁移失败提供替代解决方案

### 使用说明

1. **自动修复**
   - 访问 `/admin/settings/postmark` 页面
   - 点击"检查数据库"按钮
   - 如显示问题，点击"修复数据库"按钮
   - 系统将自动尝试多种修复方法

2. **手动修复**
   - 关闭所有使用数据库的应用
   - 以管理员身份运行命令提示符
   - 进入项目目录
   - 执行 `npx prisma db push` 或 `npx prisma migrate dev` 